name: Preview Deploy (Run)

# Triggered by preview-deploy.yml via workflow_dispatch after it has validated
# that the comment author has write access. Running under workflow_dispatch means
# this job has no untrusted-checkout exposure: inputs are dispatched by the repo's
# own workflow, not directly from PR contributor content.
#
# A fixed branch is required because the GitHub OAuth app used for auth only
# accepts a fixed set of redirect domains. Only https://preview.soten.pages.dev
# is whitelisted, so per-PR branch URLs cannot be used.
#
# Only one preview is live at a time — whoever last triggered '.preview' wins.

on:
  workflow_dispatch:
    inputs:
      sha:
        description: PR head SHA to deploy
        required: true
      pr_number:
        description: Pull request number
        required: true
      comment_id:
        description: Comment ID that triggered the deploy
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      deployments: read
      pull-requests: write

    steps:
      - name: React to trigger comment
        env:
          COMMENT_ID: ${{ inputs.comment_id }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: Number(process.env.COMMENT_ID),
              content: 'rocket',
            });

      - uses: actions/checkout@v4
        with:
          # Check out the trusted base branch only — we never populate the working tree
          # with PR code. The PR commit is fetched by its SHA and pushed directly.
          ref: main
          fetch-depth: 1

      - name: Push PR commit to preview branch
        env:
          HEAD_SHA: ${{ inputs.sha }}
        run: |
          git fetch origin "$HEAD_SHA"
          git push origin "$HEAD_SHA:refs/heads/preview" --force

      - name: Wait for Cloudflare Pages deployment
        id: wait
        env:
          HEAD_SHA: ${{ inputs.sha }}
        uses: actions/github-script@v7
        with:
          script: |
            const sha = process.env.HEAD_SHA;
            const TIMEOUT_MS = 5 * 60 * 1000;
            const POLL_MS = 15 * 1000;
            const deadline = Date.now() + TIMEOUT_MS;

            // Cloudflare Pages reports back via GitHub's Deployments API.
            // Poll until the deployment for this exact SHA reaches a terminal state.
            while (Date.now() < deadline) {
              await new Promise(r => setTimeout(r, POLL_MS));

              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha,
                per_page: 10,
              });

              for (const deployment of deployments) {
                if (!/preview/i.test(deployment.environment)) continue;

                const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  per_page: 1,
                });

                if (!statuses.length) continue;

                const { state } = statuses[0];
                core.info(`Deployment ${deployment.id} state: ${state}`);

                if (state === 'success') {
                  core.setOutput('state', 'success');
                  return;
                }
                if (state === 'failure' || state === 'error') {
                  core.setOutput('state', 'failure');
                  return;
                }
              }
            }

            core.setOutput('state', 'timeout');

      - name: Post deployment comment
        env:
          HEAD_SHA: ${{ inputs.sha }}
          PR_NUMBER: ${{ inputs.pr_number }}
          DEPLOY_STATE: ${{ steps.wait.outputs.state }}
        uses: actions/github-script@v7
        with:
          script: |
            const sha = process.env.HEAD_SHA;
            const previewUrl = 'https://preview.soten.pages.dev';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const state = process.env.DEPLOY_STATE;

            const statusLine = state === 'success'
              ? `| **Status** | Deployed |`
              : state === 'failure'
              ? `| **Status** | Build failed — [see run](${runUrl}) |`
              : `| **Status** | Timed out waiting — may still be deploying |`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(process.env.PR_NUMBER),
              body: [
                '### Cloudflare Pages Preview',
                '',
                `| | |`,
                `|---|---|`,
                statusLine,
                `| **Preview URL** | [${previewUrl}](${previewUrl}) |`,
                `| **Commit** | [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha}) |`,
                `| **Trigger** | [Run ${context.runId}](${runUrl}) |`,
              ].join('\n'),
            });
