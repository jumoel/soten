name: Preview Deploy

# Triggered by PR comments containing '.preview'.
# The commenter must have write access (OWNER, MEMBER, or COLLABORATOR) to prevent
# arbitrary users from triggering deployments that consume quota.
#
# No Cloudflare credentials are required in GitHub. The workflow pushes the PR
# content to a dedicated preview branch (`preview-pr-N`). Cloudflare Pages detects
# the push via its existing GitHub App integration and deploys automatically.
#
# The branch alias URL is predictable: https://preview-pr-N.soten.pages.dev
# This lets us post the URL immediately without polling the Cloudflare API.
#
# One-time Cloudflare dashboard setup required:
#   - In the soten Pages project, ensure preview deployments are enabled for all
#     branches (the default) or add `preview-pr-*` to the preview branch include list.
#
# Preview branches are deleted automatically when the PR is closed.

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

jobs:
  deploy-preview:
    if: >-
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '.preview') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: React to trigger comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket',
            });

      - name: Get PR head SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('head_sha', pr.head.sha);

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          # Full history not needed; we just push this SHA to the preview branch.
          fetch-depth: 1

      - name: Push to preview branch
        run: |
          git push origin HEAD:refs/heads/preview-pr-${{ github.event.issue.number }} --force

      - name: Post deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.issue.number;
            const sha = '${{ steps.pr.outputs.head_sha }}';
            const previewUrl = `https://preview-pr-${pr}.soten.pages.dev`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: [
                '### Cloudflare Pages Preview',
                '',
                'Deployment triggered. Cloudflare will build and publish in ~1 minute.',
                '',
                `| | |`,
                `|---|---|`,
                `| **Preview URL** | [${previewUrl}](${previewUrl}) |`,
                `| **Commit** | [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha}) |`,
                `| **Branch** | \`preview-pr-${pr}\` |`,
                `| **Trigger** | [Run ${context.runId}](${runUrl}) |`,
              ].join('\n'),
            });

  cleanup-preview:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Delete preview branch
        uses: actions/github-script@v7
        with:
          script: |
            const branch = `preview-pr-${context.payload.pull_request.number}`;
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.info(`Deleted branch ${branch}`);
            } catch (e) {
              // 422 = ref does not exist; nothing to clean up
              if (e.status !== 422) throw e;
              core.info(`Branch ${branch} did not exist, nothing to delete`);
            }
