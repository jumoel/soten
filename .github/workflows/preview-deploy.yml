name: Preview Deploy

# Triggered by PR comments containing '.preview'.
# The commenter must have write access (OWNER, MEMBER, or COLLABORATOR) to prevent
# arbitrary users from triggering deployments that consume quota.
#
# No Cloudflare credentials are required in GitHub. The workflow pushes the PR
# content to the `preview` branch. Cloudflare Pages detects the push via its
# existing GitHub App integration and deploys automatically.
#
# A fixed branch is required because the GitHub OAuth app used for auth only
# accepts a fixed set of redirect domains. Only https://preview.soten.pages.dev
# is whitelisted, so per-PR branch URLs cannot be used.
#
# Only one preview is live at a time — whoever last triggered `.preview` wins.

on:
  issue_comment:
    types: [created]

jobs:
  deploy-preview:
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '.preview') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

    runs-on: ubuntu-latest

    permissions:
      contents: write
      deployments: read
      pull-requests: write

    steps:
      - name: React to trigger comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket',
            });

      - name: Get PR head SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('head_sha', pr.head.sha);

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          # Full history not needed; we just push this SHA to the preview branch.
          fetch-depth: 1

      - name: Push to preview branch
        run: |
          git push origin HEAD:refs/heads/preview --force

      - name: Wait for Cloudflare Pages deployment
        id: wait
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ steps.pr.outputs.head_sha }}';
            const TIMEOUT_MS = 5 * 60 * 1000;
            const POLL_MS = 15 * 1000;
            const deadline = Date.now() + TIMEOUT_MS;

            // Cloudflare Pages reports back via GitHub's Deployments API.
            // Poll until the deployment for this exact SHA reaches a terminal state.
            while (Date.now() < deadline) {
              await new Promise(r => setTimeout(r, POLL_MS));

              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha,
                per_page: 10,
              });

              for (const deployment of deployments) {
                if (!/preview/i.test(deployment.environment)) continue;

                const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id,
                  per_page: 1,
                });

                if (!statuses.length) continue;

                const { state } = statuses[0];
                core.info(`Deployment ${deployment.id} state: ${state}`);

                if (state === 'success') {
                  core.setOutput('state', 'success');
                  return;
                }
                if (state === 'failure' || state === 'error') {
                  core.setOutput('state', 'failure');
                  return;
                }
              }
            }

            core.setOutput('state', 'timeout');

      - name: Post deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ steps.pr.outputs.head_sha }}';
            const previewUrl = 'https://preview.soten.pages.dev';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const state = '${{ steps.wait.outputs.state }}';

            const statusLine = state === 'success'
              ? `| **Status** | Deployed |`
              : state === 'failure'
              ? `| **Status** | Build failed — [see run](${runUrl}) |`
              : `| **Status** | Timed out waiting — may still be deploying |`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '### Cloudflare Pages Preview',
                '',
                `| | |`,
                `|---|---|`,
                statusLine,
                `| **Preview URL** | [${previewUrl}](${previewUrl}) |`,
                `| **Commit** | [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha}) |`,
                `| **Trigger** | [Run ${context.runId}](${runUrl}) |`,
              ].join('\n'),
            });
