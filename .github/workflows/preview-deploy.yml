name: Preview Deploy

# Triggered by PR comments containing '.preview'.
# The commenter must have write access (OWNER, MEMBER, or COLLABORATOR) to prevent
# arbitrary users from triggering deployments that consume quota.
#
# No Cloudflare credentials are required in GitHub. The workflow pushes the PR
# content to the `preview` branch. Cloudflare Pages detects the push via its
# existing GitHub App integration and deploys automatically.
#
# A fixed branch is required because the GitHub OAuth app used for auth only
# accepts a fixed set of redirect domains. Only https://preview.soten.pages.dev
# is whitelisted, so per-PR branch URLs cannot be used.
#
# Only one preview is live at a time â€” whoever last triggered `.preview` wins.

on:
  issue_comment:
    types: [created]

jobs:
  deploy-preview:
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '.preview') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: React to trigger comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket',
            });

      - name: Get PR head SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('head_sha', pr.head.sha);

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}
          # Full history not needed; we just push this SHA to the preview branch.
          fetch-depth: 1

      - name: Push to preview branch
        run: |
          git push origin HEAD:refs/heads/preview --force

      - name: Post deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ steps.pr.outputs.head_sha }}';
            const previewUrl = 'https://preview.soten.pages.dev';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                '### Cloudflare Pages Preview',
                '',
                'Deployment triggered. Cloudflare will build and publish in ~1 minute.',
                '',
                `| | |`,
                `|---|---|`,
                `| **Preview URL** | [${previewUrl}](${previewUrl}) |`,
                `| **Commit** | [\`${sha.substring(0, 7)}\`](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${sha}) |`,
                `| **Trigger** | [Run ${context.runId}](${runUrl}) |`,
              ].join('\n'),
            });
