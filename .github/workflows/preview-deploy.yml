name: Preview Deploy

# Triggered by PR comments containing '.preview'.
# The commenter must have write access (OWNER, MEMBER, or COLLABORATOR) to prevent
# arbitrary users from triggering deployments that consume quota.
#
# This workflow only validates and dispatches. All privileged operations (git push,
# PR comments) happen in preview-deploy-run.yml, which runs under workflow_dispatch.
# The two-workflow split is required because issue_comment is an untrusted trigger:
# CodeQL flags any git fetch/push of PR content in that context.

on:
  issue_comment:
    types: [created]

jobs:
  dispatch:
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '.preview') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)

    runs-on: ubuntu-latest

    permissions:
      actions: write

    steps:
      - name: Get PR head SHA and dispatch deploy
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'preview-deploy-run.yml',
              ref: 'main',
              inputs: {
                sha: pr.head.sha,
                pr_number: String(context.issue.number),
                comment_id: String(context.payload.comment.id),
              },
            });
